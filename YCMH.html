<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phiếu Yêu Cầu Mua Hàng - Công ty CP Đầu tư và Xây dựng Âu Việt</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* =======================
       MÀN HÌNH
    ======================== */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333; padding: 20px; min-height: 100vh;
      display: flex; justify-content: center; position: relative;
    }
    .container {
      width: 100%; max-width: 900px;
      background: #fff; border-radius: 14px; overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 71, 171, 0.15);
      position: relative; z-index: 0;
    }
    .container:hover { box-shadow: 0 15px 50px rgba(0, 71, 171, 0.2); }

    /* Watermark mờ */
    .container::after{
      content:""; position:absolute; inset:0; z-index:0; pointer-events:none;
      background-image:url('Kho ảnh_Images_09d5aefa.Ảnh.061339.jpg'); /* đổi nếu cần */
      background-repeat:no-repeat; background-position:50% 50%; background-size:72% auto;
      opacity:.06; transform:rotate(-15deg);
      filter:grayscale(100%) contrast(120%);
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }
    .header, .search-container, .content, .footer { position:relative; z-index:1; }

    .header {
      background: linear-gradient(135deg, #0047AB 0%, #002b6b 100%);
      color:#fff; padding: 22px 18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .logo-container { display:flex; align-items:center; gap:12px; }
    .header-logo { height:56px; width:auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); }
    .company-info { display:flex; flex-direction:column; align-items:center; flex:1; }
    .company-name { font-size:22px; font-weight:700; text-transform:uppercase; letter-spacing:.4px; }
    .document-title { font-size:26px; font-weight:800; letter-spacing:1px; }
    .document-code {
      background: rgba(255,255,255,.18); padding: 6px 10px; border-radius: 8px; font-size: 13px;
      border: 1px solid rgba(255,255,255,.3);
    }

    .search-container{
      padding: 16px 18px; background: #eaf2ff; border-bottom: 1px solid rgba(0,71,171,.1);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .search-box{ display:flex; gap:10px; align-items:center; position:relative; }
    .search-input{ width: 280px; padding: 10px 16px; border: 2px solid #0047AB; border-radius: 22px; font-size: 15px; }
    #suggestions{
      position:absolute; top:100%; left:0; width:280px; background:#fff; border:2px solid #0047AB; border-top:none;
      border-radius: 0 0 12px 12px; max-height:240px; overflow:auto; display:none; z-index:10;
    }
    #suggestions div{ padding:10px 12px; cursor:pointer; border-bottom:1px solid #eee; }
    .search-button,.print-button{
      border:none; padding:10px 18px; border-radius:22px; font-weight:600; display:inline-flex; gap:8px; align-items:center; cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .search-button{ background:#0047AB; color:#fff; }
    .print-button{ background:#28a745; color:#fff; }

    .content{ padding: 20px 18px 26px; }

    /* KHỐI THÔNG TIN – 3 CỘT */
    .top-details{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap: 10px 16px; margin-bottom: 14px; padding: 14px;
      background: #f7faff; border-left: 5px solid #0047AB; border-radius: 10px;
    }
    .project-info-item{ display:grid; grid-template-columns: 120px 1fr; gap: 8px; align-items:center; }
    .info-label{ font-weight:700; color:#0047AB; white-space:nowrap; }
    .info-value{ background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding: 8px 10px; font-weight:500; }

    /* BẢNG */
    table.items-table{ width:100%; border-collapse:collapse; margin-top: 6px; font-size:14px; }
    .items-table thead th{
      background:#0047AB; color:#fff; padding:9px 6px; border:1px solid #002b6b; text-align:center; font-weight:700;
    }
    .items-table td{
      border:1px solid #d9d9d9; padding:8px 6px; text-align:center; vertical-align:middle; background: rgba(255,255,255,.95);
    }
    .stt{ width: 44px; }
    .item-name{ width: 210px; text-align:left !important; }
    .description{ width: 180px; text-align:left !important; }
    .purpose{ width: 160px; text-align:left !important; }
    .unit{ width: 70px; }
    .quantity{ width: 80px; }
    .date{ width: 105px; }
    .location{ width: 160px; text-align:left !important; }
    .changes{ width: 160px; text-align:left !important; }

    /* CHỮ KÝ – 1 HÀNG */
    .signature-area{
      display:flex; flex-wrap: nowrap; gap:18px; margin-top: 22px; /* không cho xuống dòng */
      justify-content: space-between; align-items: flex-start;
    }
    .signature-box{
      flex: 1 1 0; min-width: 0; /* cho phép co giãn đồng đều */
      text-align:center; padding: 0 6px;
    }
    .signature-box div:first-child{ font-weight:700; }
    .signature-line{ border-top:1px solid #0047AB; margin: 24px 0 6px; padding-top:4px; font-style:italic; color:#0047AB; }

    .footer{ padding: 14px; text-align:center; background:#eef4ff; color:#0047AB; font-size:14px; border-top: 1px solid #d6e4ff; }

    .loading,.error,.no-data{ display:none; text-align:center; padding: 20px; }
    .error{ color:#d32f2f; background:#ffebee; border-left:4px solid #d32f2f; border-radius: 8px; }
    .no-data{ color:#666; font-style:italic; border:2px dashed #ccc; border-radius: 8px; }

    @media (max-width: 1024px){
      .top-details{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px){
      .container{ max-width:100%; }
      .header{ flex-direction:column; gap:8px; }
      .document-code{ align-self:flex-end; }
      .search-container{ flex-direction:column; align-items:stretch; gap:10px; }
      .search-input, #suggestions{ width:100%; }
      .top-details{ grid-template-columns: 1fr; }
      .project-info-item{ grid-template-columns: 110px 1fr; }
      .signature-area{ flex-wrap: wrap; } /* cho phép xuống dòng trên di động */
    }

    /* =======================
       IN A4 DỌC
    ======================== */
    @page { size: A4 portrait; margin: 12mm 14mm; }

    @media print{
      *{ box-shadow:none !important; text-shadow:none !important; }
      html, body{
        background:#fff !important; width:210mm; min-height:297mm; margin:0 !important; padding:0 !important;
        font-family: "Times New Roman", Times, serif !important; font-size: 11pt; line-height:1.3;
        -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
      }
      .container{ max-width:none !important; border-radius:0 !important; box-shadow:none !important; }
      .container::after{ opacity:.08 !important; background-size: 78% auto; transform: rotate(-15deg); }

      .search-container, .loading, .error, .no-data, .footer{ display:none !important; }

      .header{
        padding: 10px 12px !important; background:#0047AB !important; color:#fff !important;
        align-items:center; justify-content:space-between;
      }
      .header-logo{ height: 42px !important; }
      .company-name{ font-size: 13pt !important; }
      .document-title{ font-size: 15pt !important; }
      .document-code{
        background:#e6eefc !important; border:1px solid #bcd0ff !important; border-radius:4px !important;
        padding: 2px 6px !important; font-size:10pt !important;
      }

      .content{ padding: 10px 12px 0 12px !important; }

      /* THÔNG TIN 3 CỘT KHI IN */
      .top-details{
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px 12px !important; padding: 10px !important; margin: 8px 0 10px !important;
        background:none !important; border-left: 2px solid #0047AB !important;
        page-break-inside: avoid !important;
      }
      .project-info-item{ grid-template-columns: 130px 1fr !important; gap: 6px !important; }
      .info-label{ font-size: 10pt !important; font-weight:700 !important; color:#0047AB !important; }
      .info-value{ font-size: 11pt !important; background:none !important; border:none !important; padding:0 !important; }

      /* BẢNG A4 DỌC */
      table.items-table{
        width:100% !important; border-collapse:collapse !important; font-size: 9.2pt !important; margin: 6px 0 0 !important;
        page-break-inside:auto !important;
      }
      .items-table thead{ display: table-header-group !important; }
      .items-table th{
        background:#0047AB !important; color:#fff !important; padding: 6px 4px !important; border:1px solid #002b6b !important; text-align:center !important;
      }
      .items-table td{
        padding: 5px 4px !important; border:1px solid #cfcfcf !important; text-align:center !important; vertical-align:middle !important; line-height:1.2 !important;
        page-break-inside: avoid !important;
      }
      .items-table tr{ page-break-inside: avoid !important; }

      /* Chiều rộng cột khi in (portrait) */
      .stt{ width: 16mm !important; }
      .item-name{ width: 50mm !important; text-align:left !important; }
      .description{ width: 42mm !important; text-align:left !important; }
      .purpose{ width: 36mm !important; text-align:left !important; }
      .unit{ width: 16mm !important; }
      .quantity{ width: 18mm !important; }
      .date{ width: 24mm !important; }
      .location{ width: 32mm !important; text-align:left !important; }
      .changes{ width: 32mm !important; text-align:left !important; }

      /* CHỮ KÝ 1 HÀNG KHI IN */
      .signature-area{
        margin-top: 12px !important; gap: 12px !important;
        display:flex !important; flex-wrap: nowrap !important; justify-content: space-between !important;
        page-break-inside: avoid !important;
      }
      .signature-box{
        flex: 1 1 0 !important; min-width: 0 !important; text-align:center !important;
      }
      .signature-line{
        border-top: 1px solid #0047AB !important; margin: 18px 0 4px !important;
        padding-top:3px !important; font-size: 9pt !important; color:#0047AB !important;
      }

      .items-table tr:hover{ background:none !important; transform:none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="logo-container">
        <img src="Kho ảnh_Images_09d5aefa.Ảnh.061339.jpg" alt="Au Viet Construction Logo" class="header-logo">
      </div>
      <div class="company-info">
        <div class="company-name">CÔNG TY CỔ PHẦN ĐẦU TƯ VÀ XÂY DỰNG ÂU VIỆT</div>
        <div class="document-title">YÊU CẦU MUA HÀNG</div>
      </div>
      <div class="document-code">Mã: BM-2</div>
    </div>

    <!-- TÌM KIẾM -->
    <div class="search-container">
      <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="Nhập mã YCMH để tìm kiếm...">
        <div id="suggestions"></div>
        <button id="search-button" class="search-button"><i class="fas fa-search"></i> Tìm kiếm</button>
      </div>
      <button id="print-button" class="print-button"><i class="fas fa-print"></i> In phiếu</button>
    </div>

    <!-- NỘI DUNG -->
    <div class="content">
      <!-- THÔNG TIN 3 CỘT -->
      <div class="top-details">
        <div class="project-info-item">
          <div class="info-label">Công trình:</div>
          <div class="info-value" id="project-name">Chưa có dữ liệu</div>
        </div>
        <div class="project-info-item">
          <div class="info-label">Khách hàng:</div>
          <div class="info-value" id="customer-name">Chưa có dữ liệu</div>
        </div>
        <div class="project-info-item">
          <div class="info-label">Số YCMH:</div>
          <div class="info-value" id="request-code">Chưa có dữ liệu</div>
        </div>
        <div class="project-info-item">
          <div class="info-label">Ngày yêu cầu:</div>
          <div class="info-value" id="request-date">Chưa có dữ liệu</div>
        </div>
        <div class="project-info-item">
          <div class="info-label">Bộ phận:</div>
          <div class="info-value" id="request-department">Văn phòng</div>
        </div>
        <div class="project-info-item">
          <div class="info-label">Tổng mặt hàng:</div>
          <div class="info-value" id="total-items">0</div>
        </div>
      </div>

      <!-- BẢNG CHI TIẾT -->
      <table class="items-table">
        <thead>
          <tr>
            <th class="stt">STT</th>
            <th class="item-name">Mặt hàng</th>
            <th class="description">Mô tả</th>
            <th class="purpose">Mục đích</th>
            <th class="unit">ĐVT</th>
            <th class="quantity">SL</th>
            <th class="date">Ngày nhập</th>
            <th class="location">Vị trí</th>
            <th class="changes">Thay đổi TK</th>
          </tr>
        </thead>
        <tbody id="items-body"></tbody>
      </table>

      <!-- KHÔNG DỮ LIỆU -->
      <div id="no-data" class="no-data">
        <i class="fas fa-inbox" style="font-size: 46px; margin-bottom: 8px; color:#bbb;"></i>
        <div>Không tìm thấy dữ liệu cho mã YCMH này.</div>
        <div style="font-size: 14px; margin-top: 6px;">Vui lòng kiểm tra lại mã YCMH hoặc thử tìm kiếm khác.</div>
      </div>

      <!-- CHỮ KÝ – 1 HÀNG -->
      <div class="signature-area">
        <div class="signature-box">
          <div>NGƯỜI LẬP</div>
          <div class="signature-line">(Ký, ghi rõ họ tên)</div>
        </div>
        <div class="signature-box">
          <div>NGƯỜI KIỂM TRA</div>
          <div class="signature-line">(Ký, ghi rõ họ tên)</div>
        </div>
        <div class="signature-box">
          <div>NGƯỜI PHÊ DUYỆT</div>
          <div class="signature-line">(Ký, ghi rõ họ tên)</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Phiếu yêu cầu mua hàng - Công ty Cổ phần Đầu tư và Xây Dựng Âu Việt</div>
    </div>
  </div>

  <div class="loading" id="loading"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</div>
  <div class="error" id="error"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const apiUrl = 'https://script.google.com/macros/s/AKfycbz45axkSa-92kz-vCqAQ1xwmRjlFWqX6b0v-B0ENI73UIa8M9RzCXDkSQtNcwhFX2FA/exec';
      const loadingElement = document.getElementById('loading');
      const errorElement = document.getElementById('error');
      const noDataElement = document.getElementById('no-data');
      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('search-button');
      const printButton = document.getElementById('print-button');
      const suggestionBox = document.getElementById('suggestions');

      let allData = null;
      let availableRequests = [];

      // lấy id từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const requestId = urlParams.get('id');
      if (requestId) searchInput.value = requestId;

      // tải dữ liệu
      fetch(apiUrl)
        .then(r => { if (!r.ok) throw new Error('Không thể kết nối đến server'); return r.json(); })
        .then(data => {
          loadingElement.style.display = 'none';
          allData = data;
          if (allData?.['Phiếu YCMH']?.data?.length) {
            availableRequests = allData['Phiếu YCMH'].data.map(x => x.ID).filter(Boolean);
          }
          if (requestId) searchRequest(requestId);
          else if (allData?.['Phiếu YCMH']?.data?.length) displayRequest(allData['Phiếu YCMH'].data[0]);
          else { clearRequestData(); noDataElement.style.display = 'block'; }
        })
        .catch(err => { loadingElement.style.display = 'none'; showError('Lỗi khi tải dữ liệu: ' + err.message); });

      // tìm kiếm
      searchButton.addEventListener('click', () => {
        const v = searchInput.value.trim();
        if (v) searchRequest(v); else showError('Vui lòng nhập mã YCMH để tìm kiếm');
        suggestionBox.style.display = 'none';
      });
      searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchButton.click(); });

      // gợi ý
      searchInput.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        suggestionBox.innerHTML = ''; suggestionBox.style.display = 'none';
        if (!availableRequests.length) return;
        const list = q ? availableRequests.filter(id => id?.toLowerCase().includes(q)) : availableRequests;
        list.slice(0,10).forEach(id => {
          const d = document.createElement('div'); d.textContent = id;
          d.onclick = () => { searchInput.value = id; suggestionBox.style.display = 'none'; searchRequest(id); };
          suggestionBox.appendChild(d);
        });
        if (suggestionBox.children.length) suggestionBox.style.display = 'block';
      });
      document.addEventListener('click', e => {
        if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) suggestionBox.style.display = 'none';
      });

      // in
      printButton.addEventListener('click', () => window.print());

      function searchRequest(id){
        if (!allData) return;
        errorElement.style.display = 'none'; noDataElement.style.display = 'none';
        const list = allData['Phiếu YCMH']?.data || [];
        const found = list.find(x => x.ID && x.ID.toLowerCase() === id.toLowerCase());
        if (found) displayRequest(found);
        else { clearRequestData(); noDataElement.style.display = 'block'; }
      }

      function displayRequest(row){
        document.getElementById('project-name').textContent = row['Tên công trình'] || 'Chưa có dữ liệu';
        document.getElementById('customer-name').textContent = row['Tên công ty'] || 'Âu Việt';
        document.getElementById('request-code').textContent = row.ID || 'Chưa có dữ liệu';
        const reqDate = row['Ngày yêu cầu']
          ? new Date(row['Ngày yêu cầu']).toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'})
          : new Date().toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
        document.getElementById('request-date').textContent = reqDate;
        document.getElementById('request-department').textContent = row['Bộ phận'] || 'Văn phòng';

        const details = (allData['YCMH chi tiết']?.data || []).filter(d => d['Mã phiếu YCMH'] === row.ID);
        document.getElementById('total-items').textContent = details.length;

        const tbody = document.getElementById('items-body');
        tbody.innerHTML = '';
        if (details.length){
          details.forEach((item, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="stt">${item.STT || (idx + 1)}</td>
              <td class="item-name">${item['Mặt hàng'] || ''}</td>
              <td class="description">${item['Mô tả'] || ''}</td>
              <td class="purpose">${item['Mục đích sử dụng'] || ''}</td>
              <td class="unit">${item['Đơn vị tính'] || ''}</td>
              <td class="quantity">${item['Số lượng'] || ''}</td>
              <td class="date">${
                item['Ngày nhập hàng'] ? new Date(item['Ngày nhập hàng']).toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'}) : ''
              }</td>
              <td class="location">${item['Vị trí nhập hàng'] || ''}</td>
              <td class="changes">${item['Thay đổi so với TK'] || ''}</td>`;
            tbody.appendChild(tr);
          });
        }else{
          noDataElement.style.display = 'block';
        }
      }

      function clearRequestData(){
        document.getElementById('project-name').textContent = 'Chưa có dữ liệu';
        document.getElementById('customer-name').textContent = 'Chưa có dữ liệu';
        document.getElementById('request-code').textContent = 'Chưa có dữ liệu';
        document.getElementById('request-date').textContent = 'Chưa có dữ liệu';
        document.getElementById('request-department').textContent = 'Chưa có dữ liệu';
        document.getElementById('total-items').textContent = '0';
        document.getElementById('items-body').innerHTML = '';
      }

      function showError(msg){
        errorElement.textContent = msg;
        errorElement.style.display = 'block';
        document.getElementById('items-body').innerHTML = '';
        noDataElement.style.display = 'none';
      }
    });
  </script>
</body>
</html>
