<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xuất dữ liệu vận đơn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f5f5f5;
        }
        .message {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="loadingMessage">Đang tạo file Excel, vui lòng chờ...</div>
    <div id="successMessage" class="message" style="display: none;">
        File Excel đã được tải xuống. Trang sẽ tự động đóng sau 3 giây...
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy tham số từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const jsonData = urlParams.get('data');
            
            let bills = [];
            
            if (jsonData) {
                try {
                    // Giải mã JSON từ URL
                    bills = JSON.parse(decodeURIComponent(jsonData));
                    
                    if (bills.length > 0) {
                        // Chuẩn bị dữ liệu cho Excel với các cột theo yêu cầu
                        const excelData = [
                            ["STT", "Số Bill", "Tỉnh nhận", "Ngày bốc", "Mã khách gửi", 
                             "Tên khách gửi", "Tên khách nhận", "Địa chỉ nhận", "Xã nhận",
                             "SĐT khách nhận", "Dịch vụ GTGT", "Nội dung hàng hóa", 
                             "Số kiện", "Đã phát", "Còn lại", "Ghi chú"],
                            ...bills.map((bill, index) => [
                                index + 1, // STT tự động
                                bill.soBill || '',
                                bill.tinhNhan || '',
                                bill.ngayBoc || '',
                                bill.maKhachGui || '',
                                bill.tenKhachGui || '',
                                bill.tenKhachNhan || '',
                                bill.diaChiNhan || '',
                                bill.xaNhan || '',
                                bill.sdtKhachNhan || '',
                                bill.dichVuGTGT || '',
                                bill.noiDungHangHoa || '',
                                bill.soKien || '',
                                bill.daPhat || '',
                                bill.conLai || '',
                                bill.ghiChu || ''
                            ])
                        ];
                        
                        // Tạo workbook Excel
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(excelData);
                        
                        // Định dạng cột
                        ws['!cols'] = [
                            {width: 5},   // STT
                            {width: 12},  // Số Bill
                            {width: 15},  // Tỉnh nhận
                            {width: 12},  // Ngày bốc
                            {width: 15},  // Mã khách gửi
                            {width: 20},  // Tên khách gửi
                            {width: 20},  // Tên khách nhận
                            {width: 25},  // Địa chỉ nhận
                            {width: 15},  // Xã nhận
                            {width: 15},  // SĐT khách nhận
                            {width: 15},  // Dịch vụ GTGT
                            {width: 20},  // Nội dung hàng hóa
                            {width: 10},  // Số kiện
                            {width: 10},  // Đã phát
                            {width: 10},  // Còn lại
                            {width: 20}   // Ghi chú
                        ];
                        
                        XLSX.utils.book_append_sheet(wb, ws, "Danh sách vận đơn");
                        
                        // Xuất file Excel
                        const fileName = "danh_sach_van_don_" + new Date().toISOString().slice(0,10) + ".xlsx";
                        XLSX.writeFile(wb, fileName);
                        
                        // Hiển thị thông báo thành công
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // Tự động đóng trang sau 3 giây
                        setTimeout(function() {
                            window.close();
                        }, 3000);
                    } else {
                        document.getElementById('loadingMessage').textContent = 'Không có dữ liệu vận đơn nào!';
                        setTimeout(function() {
                            window.close();
                        }, 3000);
                    }
                    
                } catch (e) {
                    console.error('Lỗi phân tích dữ liệu:', e);
                    document.getElementById('loadingMessage').textContent = 'Lỗi khi xử lý dữ liệu!';
                    setTimeout(function() {
                        window.close();
                    }, 3000);
                }
            } else {
                document.getElementById('loadingMessage').textContent = 'Không có dữ liệu vận đơn!';
                setTimeout(function() {
                    window.close();
                }, 3000);
            }
        });
    </script>
</body>
</html>
